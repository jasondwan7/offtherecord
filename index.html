import React, { CSSProperties, useEffect, useMemo, useRef, useState, PropsWithChildren } from "react";

/**
 * GradualBlur component (no external deps)
 * - Ported from your snippet and inlined here so it runs out‑of‑the‑box.
 */

type GradualBlurProps = {
  position?: "top" | "bottom" | "left" | "right";
  strength?: number;
  height?: string;
  width?: string;
  divCount?: number;
  exponential?: boolean;
  zIndex?: number;
  animated?: boolean | "scroll";
  duration?: string;
  easing?: string;
  opacity?: number;
  curve?: "linear" | "bezier" | "ease-in" | "ease-out" | "ease-in-out";
  responsive?: boolean;
  mobileHeight?: string;
  tabletHeight?: string;
  desktopHeight?: string;
  mobileWidth?: string;
  tabletWidth?: string;
  desktopWidth?: string;
  preset?:
    | "top"
    | "bottom"
    | "left"
    | "right"
    | "subtle"
    | "intense"
    | "smooth"
    | "sharp"
    | "header"
    | "footer"
    | "sidebar"
    | "page-header"
    | "page-footer";
  gpuOptimized?: boolean;
  hoverIntensity?: number;
  target?: "parent" | "page";
  onAnimationComplete?: () => void;
  className?: string;
  style?: CSSProperties;
};

const DEFAULT_CONFIG: Partial<GradualBlurProps> = {
  position: "bottom",
  strength: 2,
  height: "6rem",
  divCount: 5,
  exponential: false,
  zIndex: 1000,
  animated: false,
  duration: "0.3s",
  easing: "ease-out",
  opacity: 1,
  curve: "linear",
  responsive: false,
  target: "parent",
  className: "",
  style: {}
};

const PRESETS: Record<string, Partial<GradualBlurProps>> = {
  top: { position: "top", height: "6rem" },
  bottom: { position: "bottom", height: "6rem" },
  left: { position: "left", height: "6rem" },
  right: { position: "right", height: "6rem" },
  subtle: { height: "4rem", strength: 1, opacity: 0.8, divCount: 3 },
  intense: { height: "10rem", strength: 4, divCount: 8, exponential: true },
  smooth: { height: "8rem", curve: "bezier", divCount: 10 },
  sharp: { height: "5rem", curve: "linear", divCount: 4 },
  header: { position: "top", height: "8rem", curve: "ease-out" },
  footer: { position: "bottom", height: "8rem", curve: "ease-out" },
  sidebar: { position: "left", height: "6rem", strength: 2.5 },
  "page-header": {
    position: "top",
    height: "10rem",
    target: "page",
    strength: 3
  },
  "page-footer": {
    position: "bottom",
    height: "10rem",
    target: "page",
    strength: 3
  }
};

const CURVE_FUNCTIONS: Record<string, (p: number) => number> = {
  linear: (p) => p,
  bezier: (p) => p * p * (3 - 2 * p),
  "ease-in": (p) => p * p,
  "ease-out": (p) => 1 - Math.pow(1 - p, 2),
  "ease-in-out": (p) => (p < 0.5 ? 2 * p * p : 1 - Math.pow(-2 * p + 2, 2) / 2)
};

const mergeConfigs = (...configs: Partial<GradualBlurProps>[]): Partial<GradualBlurProps> =>
  configs.reduce((acc, c) => ({ ...acc, ...c }), {});

const getGradientDirection = (position: string): string => {
  const directions: Record<string, string> = {
    top: "to top",
    bottom: "to bottom",
    left: "to left",
    right: "to right"
  };
  return directions[position] || "to bottom";
};

const debounce = <T extends (...a: any[]) => void>(fn: T, wait: number) => {
  let t: ReturnType<typeof setTimeout>;
  return (...a: Parameters<T>) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...a), wait);
  };
};

const useResponsiveDimension = (
  responsive: boolean | undefined,
  config: Partial<GradualBlurProps>,
  key: keyof GradualBlurProps
) => {
  const [val, setVal] = useState<any>(config[key]);
  useEffect(() => {
    if (!responsive) return;
    const calc = () => {
      const w = window.innerWidth;
      let v: any = config[key];
      const cap = (s: string) => s.charAt(0).toUpperCase() + s.slice(1);
      const k = cap(key as string);
      if (w <= 480 && (config as any)["mobile" + k]) v = (config as any)["mobile" + k];
      else if (w <= 768 && (config as any)["tablet" + k]) v = (config as any)["tablet" + k];
      else if (w <= 1024 && (config as any)["desktop" + k]) v = (config as any)["desktop" + k];
      setVal(v);
    };
    const deb = debounce(calc, 100);
    calc();
    window.addEventListener("resize", deb);
    return () => window.removeEventListener("resize", deb);
  }, [responsive, config, key]);
  return responsive ? val : (config as any)[key];
};

const useIntersectionObserver = (
  ref: React.RefObject<HTMLDivElement | null>,
  shouldObserve: boolean = false
) => {
  const [isVisible, setIsVisible] = useState(!shouldObserve);

  useEffect(() => {
    if (!shouldObserve || !ref.current) return;

    const observer = new IntersectionObserver(
      ([entry]) => setIsVisible(entry.isIntersecting),
      { threshold: 0.1 }
    );

    observer.observe(ref.current);
    return () => observer.disconnect();
  }, [ref, shouldObserve]);

  return isVisible;
};

const GradualBlur: React.FC<PropsWithChildren<GradualBlurProps>> = (props) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const [isHovered, setIsHovered] = useState(false);

  const config = useMemo(() => {
    const presetConfig = props.preset && PRESETS[props.preset] ? PRESETS[props.preset] : {};
    return mergeConfigs(DEFAULT_CONFIG, presetConfig, props) as Required<GradualBlurProps>;
  }, [props]);

  const responsiveHeight = useResponsiveDimension(config.responsive, config, "height");
  const responsiveWidth = useResponsiveDimension(config.responsive, config, "width");

  const isVisible = useIntersectionObserver(containerRef, config.animated === "scroll");

  const blurDivs = useMemo(() => {
    const divs: React.ReactNode[] = [];
    const increment = 100 / (config.divCount || 1);
    const currentStrength =
      isHovered && config.hoverIntensity ? (config.strength || 0) * config.hoverIntensity : config.strength || 0;

    const curveFunc = CURVE_FUNCTIONS[config.curve || "linear"] || CURVE_FUNCTIONS.linear;

    for (let i = 1; i <= (config.divCount || 1); i++) {
      let progress = i / (config.divCount || 1);
      progress = curveFunc(progress);

      let blurValue: number;
      if (config.exponential) {
        blurValue = Number(Math.pow(2, progress * 4)) * 0.0625 * currentStrength;
      } else {
        blurValue = 0.0625 * (progress * (config.divCount || 1) + 1) * currentStrength;
      }

      const p1 = Math.round((increment * i - increment) * 10) / 10;
      const p2 = Math.round(increment * i * 10) / 10;
      const p3 = Math.round((increment * i + increment) * 10) / 10;
      const p4 = Math.round((increment * i + increment * 2) * 10) / 10;

      let gradient = `transparent ${p1}%, black ${p2}%`;
      if (p3 <= 100) gradient += `, black ${p3}%`;
      if (p4 <= 100) gradient += `, transparent ${p4}%`;

      const direction = getGradientDirection(config.position || "bottom");

      const divStyle: CSSProperties = {
        position: "absolute",
        inset: "0",
        maskImage: `linear-gradient(${direction}, ${gradient})`,
        WebkitMaskImage: `linear-gradient(${direction}, ${gradient})`,
        backdropFilter: `blur(${blurValue.toFixed(3)}rem)`,
        WebkitBackdropFilter: `blur(${blurValue.toFixed(3)}rem)`,
        opacity: config.opacity,
        transition:
          config.animated && config.animated !== "scroll"
            ? `backdrop-filter ${config.duration} ${config.easing}`
            : undefined
      };

      divs.push(<div key={i} style={divStyle} />);
    }

    return divs;
  }, [config, isHovered]);

  const containerStyle: CSSProperties = useMemo(() => {
    const isVertical = ["top", "bottom"].includes(config.position || "bottom");
    const isHorizontal = ["left", "right"].includes(config.position || "bottom");
    const isPageTarget = config.target === "page";

    const baseStyle: CSSProperties = {
      position: isPageTarget ? "fixed" : "absolute",
      pointerEvents: config.hoverIntensity ? "auto" : "none",
      opacity: isVisible ? 1 : 0,
      transition: config.animated ? `opacity ${config.duration} ${config.easing}` : undefined,
      zIndex: isPageTarget ? (config.zIndex || 0) + 100 : config.zIndex,
      ...(config.style || {})
    };

    if (isVertical) {
      baseStyle.height = responsiveHeight as string;
      baseStyle.width = (responsiveWidth as string) || "100%";
      (baseStyle as any)[config.position || "bottom"] = 0;
      (baseStyle as any).left = 0;
      (baseStyle as any).right = 0;
    } else if (isHorizontal) {
      baseStyle.width = (responsiveWidth as string) || (responsiveHeight as string);
      baseStyle.height = "100%";
      (baseStyle as any)[config.position || "bottom"] = 0;
      (baseStyle as any).top = 0;
      (baseStyle as any).bottom = 0;
    }

    return baseStyle;
  }, [config, responsiveHeight, responsiveWidth, isVisible]);

  const { hoverIntensity, animated, onAnimationComplete, duration } = config as any;
  useEffect(() => {
    if (isVisible && animated === "scroll" && onAnimationComplete) {
      const t = setTimeout(() => onAnimationComplete(), parseFloat(duration) * 1000);
      return () => clearTimeout(t);
    }
  }, [isVisible, animated, onAnimationComplete, duration]);

  useEffect(() => {
    // Inject minimal styles once
    const styleId = "gradual-blur-styles";
    if (typeof document !== "undefined" && !document.getElementById(styleId)) {
      const styleElement = document.createElement("style");
      styleElement.id = styleId;
      styleElement.textContent = `.gradual-blur{pointer-events:none;transition:opacity 0.3s ease-out}.gradual-blur-inner{pointer-events:none}`;
      document.head.appendChild(styleElement);
    }
  }, []);

  return (
    <div
      ref={containerRef}
      className={`gradual-blur ${config.target === "page" ? "gradual-blur-page" : "gradual-blur-parent"} ${
        config.className || ""
      }`}
      style={containerStyle}
      onMouseEnter={hoverIntensity ? () => setIsHovered(true) : undefined}
      onMouseLeave={hoverIntensity ? () => setIsHovered(false) : undefined}
    >
      <div className="gradual-blur-inner" style={{ position: "relative", width: "100%", height: "100%" }}>
        {blurDivs}
      </div>
    </div>
  );
};

const GradualBlurMemo = React.memo(GradualBlur) as any;
GradualBlurMemo.displayName = "GradualBlur";
GradualBlurMemo.PRESETS = PRESETS;
GradualBlurMemo.CURVE_FUNCTIONS = CURVE_FUNCTIONS;

/**
 * Page Styles (kept close for single‑file portability)
 */
const styles = `
:root{
  --bg:#0b0b10; --text:#e6e6f0; --muted:#a6a6b3; --brand1:#a855f7; --brand2:#22d3ee;
}
*{box-sizing:border-box}
html,body,#root{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg)}
.bg{position:fixed;inset:0;z-index:-2;background:
  radial-gradient(1200px 800px at 75% 75%, rgba(18,245,227,.10), transparent 60%),
  radial-gradient(1000px 700px at 20% 30%, rgba(168,85,247,.10), transparent 60%),
  linear-gradient(180deg, #0b0b12 0%, #0a0a11 100%)}
.bg:after{content:"";position:absolute;inset:0;opacity:.25;background-image:radial-gradient(rgba(255,255,255,.06) 1px, transparent 1px);background-size:26px 26px;}
header{position:sticky;top:0;z-index:20;backdrop-filter:blur(8px);background:rgba(12,12,18,.8);border-bottom:1px solid rgba(255,255,255,.06)}
.nav{max-width:1180px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
.brand{display:flex;align-items:center;gap:12px;color:#fff;font-weight:800;text-decoration:none}
.brand img{height:42px}
.menu{display:flex;gap:28px;align-items:center}
.menu a{color:var(--muted);text-decoration:none;font-weight:600}
.menu a:hover{color:#fff}
.menu a.active{color:#d8caff}
.hero{min-height:calc(100vh - 72px);display:grid;place-items:center;text-align:center}
.hero h1{font-weight:900;font-size:clamp(42px,8vw,124px);margin:0 0 18px;background:linear-gradient(90deg,var(--brand1) 0%,#e9a3ff 30%,#93c5fd 55%,var(--brand2) 100%);-webkit-background-clip:text;color:transparent}
.subtitle{max-width:860px;margin:0 auto 36px;color:#c9c9d6;font-size:clamp(16px,2.2vw,26px)}
.cta{display:flex;gap:18px;justify-content:center;flex-wrap:wrap}
.btn{padding:16px 26px;font-weight:800;border-radius:14px;text-decoration:none}
.btn.primary{color:#fff;background:linear-gradient(90deg,var(--brand1),var(--brand2))}
.btn.ghost{color:#cbb8ff;border:1px solid rgba(168,85,247,.45)}
.container{max-width:1180px;padding:0 20px;margin:0 auto}
section{padding:100px 0;border-top:1px solid rgba(255,255,255,.06)}
section h2{font-size:42px;margin:0 0 12px}
section p{color:#bcbcd0;font-size:18px;max-width:760px}
`;

const StyleInjector: React.FC = () => {
  useEffect(() => {
    const id = "otr-styles";
    if (!document.getElementById(id)) {
      const s = document.createElement("style");
      s.id = id; s.textContent = styles; document.head.appendChild(s);
    }
  }, []);
  return null;
};

/**
 * Replace the src below with your local file name (e.g. "/otr-website.png")
 */
const LOGO_SRC = "otr-website.png"; // place the provided PNG next to your app build

const Hero: React.FC = () => (
  <section className="hero" id="home">
    <div className="container">
      <h1>OFF THE RECORD</h1>
      <p className="subtitle">Exclusive underground gatherings every 6 weeks. Phone‑free zones. Only <strong>2</strong> events remaining in 2025.</p>
      <div className="cta">
        <a className="btn primary" href="#events">View Events →</a>
        <a className="btn ghost" href="#tickets">Buy Tickets</a>
      </div>
    </div>
  </section>
);

const Nav: React.FC = () => (
  <header>
    <nav className="nav">
      <a className="brand" href="#home">
        <img src={LOGO_SRC} alt="OFF THE RECORD logo" />
      </a>
      <div className="menu">
        <a className="active" href="#home">Home</a>
        <a href="#events">Events</a>
        <a href="#about">About</a>
        <a href="#faq">FAQ</a>
        <a href="#tickets">Tickets</a>
      </div>
    </nav>
  </header>
);

const Sections: React.FC = () => (
  <>
    <section id="events" className="container">
      <h2>Events</h2>
      <p>Drop your upcoming dates, locations, and set times here. Embed a checkout or link the buttons above.</p>
    </section>
    <section id="about" className="container">
      <h2>About</h2>
      <p>OFF THE RECORD is a phone‑free, vibe‑first series running roughly every six weeks. Replace this copy with your brand story and values.</p>
    </section>
    <section id="faq" className="container">
      <h2>FAQ</h2>
      <p>Answer common questions: dress code, door policy, refunds, accessibility, etc.</p>
    </section>
    <section id="tickets" className="container">
      <h2>Tickets</h2>
      <p>Connect to Stripe/Eventbrite/Universe or your preferred ticketing provider.</p>
    </section>
  </>
);

export default function App(){
  return (
    <>
      <StyleInjector />
      <div className="bg" aria-hidden="true" />
      {/* Page‑level blurs (top & bottom) */}
      <GradualBlurMemo preset="page-header" animated duration="0.6s" easing="ease-out" opacity={0.9} />
      <GradualBlurMemo preset="page-footer" animated duration="0.6s" easing="ease-out" opacity={0.9} />

      <Nav />
      <Hero />
      <Sections />
    </>
  );
}
